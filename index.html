<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8" />
    <title>crowd-simulation</title>
    <!-- Link to the last version of BabylonJS -->
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <!-- Link to the last version of BabylonJS loaders to enable loading filetypes such as .gltf -->
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <!-- Link to pep.js to ensure pointer events work consistently in all browsers -->
    <script src="https://code.jquery.com/pep/0.4.1/pep.js"></script>

    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        .setting-name {
            display: flex; 
            flex-direction: row;
            padding-top: 10px
        }
    </style>
</head>

<body>
    <canvas id="renderCanvas">
    </canvas>
    <div style='color: white; position: absolute; top: 1%; left: 85%; z-index: 100;'>
        <form name="params" action="" method="GET">
            <div>
                <div class="setting-name">
                    <div>Agents:&nbsp;</div>
                    <div id='agents-amount-div'></div>
                </div>
                <input id='agents-amount-input' onchange="onAgentsChange()" type="range" name="agentsAmount" min="1"
                    max="100" value="100">
                <div class="setting-name">
                    <div>Neighbour Radius:&nbsp;</div>
                    <div id='neighbour-radius-div'></div>
                </div>
                <input id='neighbour-radius-input' onchange="onNeighbourRadiusChange()" type="range" name="neighbourRadius"
                    min="1" max="100" value="50">
                <div class="setting-name">
                    <div>Observable Degree:&nbsp;</div>
                    <div id='observe-degree-div'></div>
                </div>
                <input id='observe-degree-input' onchange="onObserveDegreeChange()" type="range" name="observeDegree"
                    min="30" max="270" value="120">
                <div class="setting-name">
                    <div>Minimal Distance:&nbsp;</div>
                    <div id='min-distance-div'></div>
                </div>
                <input id='min-distance-input' onchange="onMinDistanceChange()" type="range" name="minDistance" min="1"
                    max="50" value="20">
                <div class="setting-name">
                    <div>Weight Neighbour Velocity:&nbsp;</div>
                    <div id='weight-neighbour-velocity-div'></div>
                </div>
                <input id='weight-neighbour-velocity-input' onchange="onWeightNeighbourVelocityChange()" type="range"
                    name="weightNeighbourVelocity" min="0.05" max="1" value="0.1" step="0.05">
                <div class="setting-name">
                    <div>Weight Neighbour Distance:&nbsp;</div>
                    <div id='weight-neighbour-distance-div'></div>
                </div>
                <input id='weight-neighbour-distance-input' onchange="onWeightNeighbourDistanceChange()" type="range"
                    name="weightNeighbourDistance" min="0.05" max="1" value="0.15" step="0.05">
                <div class="setting-name">
                    <div>Weight Minimal Distance:&nbsp;</div>
                    <div id='weight-minimal-distance-div'></div>
                </div>
                <input id='weight-minimal-distance-input' onchange="onWeightMinimalDistanceChange()" type="range" name="weightMinimalDistance"
                    min="0.05" max="1" value="0.15" step="0.05">
                <div class="setting-name">
                    <div>Weight Perturbation:&nbsp;</div>
                    <div id='weight-perturbation-div'></div>
                </div>
                <input id='weight-perturbation-input' onchange="onWieghtPerturbationChange()" type="range" name="weightPerturbation"
                    min="0.05" max="1" value="0.1" step="0.05">
                <div class="setting-name">
                    <div>Max Velocity:&nbsp;</div>
                    <div id='max-velocity-div'></div>
                </div>
                <input id='max-velocity-input' onchange="onMaxVelocityChange()" type="range" name="maxVelocity" min="1"
                    max="10" value="2">
            </div>

            <input type="button" value="Update" onClick="update_scene();" style="margin-top: 10px; width: 70px; height: 20px; border: none; border-radius: 2px; background-color: rgba(161, 224, 103, 0.726); ">
            <input type="button" value="Repaint" onClick="repaint_scene();" style="margin-top: 10px; width: 70px; height: 20px; border: none; border-radius: 2px; background-color: rgba(224, 103, 103, 0.726); ">
        </form>
    </div>
</body>
<script src="./js/constants.js"></script>
<script>
    const agentsAmountDiv = document.getElementById('agents-amount-div');
    const neighbourRadiusDiv = document.getElementById('neighbour-radius-div');
    const observeDegreeDiv = document.getElementById('observe-degree-div');
    const minDistanceDiv = document.getElementById('min-distance-div');
    const weightNeighbourVelocityDiv = document.getElementById('weight-neighbour-velocity-div');
    const weightNeighbourDistanceDiv = document.getElementById('weight-neighbour-distance-div');
    const weightMinimalDistanceDiv = document.getElementById('weight-minimal-distance-div');
    const weightPerturbationDiv = document.getElementById('weight-perturbation-div');
    const maxVelocityDiv = document.getElementById('max-velocity-div');

    function onAgentsChange() {
        agentsAmountDiv.innerHTML = document.params.agentsAmount.value;
    };

    function onNeighbourRadiusChange() {
        neighbourRadiusDiv.innerHTML = document.params.neighbourRadius.value;
    };

    function onObserveDegreeChange() {
        observeDegreeDiv.innerHTML = document.params.observeDegree.value;
    };

    function onMinDistanceChange() {
        minDistanceDiv.innerHTML = document.params.minDistance.value;
    };

    function onWeightNeighbourVelocityChange() {
        weightNeighbourVelocityDiv.innerHTML = document.params.weightNeighbourVelocity.value;
    };

    function onWeightNeighbourDistanceChange() {
        weightNeighbourDistanceDiv.innerHTML = document.params.weightNeighbourDistance.value;
    };

    function onWeightMinimalDistanceChange() {
        weightMinimalDistanceDiv.innerHTML = document.params.weightMinimalDistance.value;
    };

    function onWieghtPerturbationChange() {
        weightPerturbationDiv.innerHTML = document.params.weightPerturbation.value;
    };

    function onMaxVelocityChange() {
        maxVelocityDiv.innerHTML = document.params.maxVelocity.value;
    };
    onAgentsChange();
    onNeighbourRadiusChange();
    onObserveDegreeChange();
    onMinDistanceChange();
    onWeightNeighbourVelocityChange();
    onWeightNeighbourDistanceChange();
    onWeightMinimalDistanceChange();
    onWieghtPerturbationChange();
    onMaxVelocityChange();
</script>
<script>
    var scene;
    const canvas = document.getElementById('renderCanvas');
    const engine = new BABYLON.Engine(canvas, true);
    window.addEventListener('DOMContentLoaded', function () {
        var createScene = function () {
            const scene = new BABYLON.Scene(engine);
            createCamera(scene, canvas, CAMERA_ANGLE, CAMERA_ZOOM, CAMERA_POS_X, CAMERA_POS_Y);
            createLights(scene);
            createGround(scene, GROUND_WIDTH, GROUND_HEIGHT, INIT_POS_X, INIT_POS_Z);
            agents = createAgentMeshes(scene);

            return scene;
        };
        scene = createScene();
        start();
        engine.runRenderLoop(function () {
            scene.render();
        });
        window.addEventListener('resize', function () {
            engine.resize();
        });
    });
    function update_scene(){
        if(agents.length < document.params.agentsAmount.value) return;
        update_params();
    }

    function update_params() {
        AMOUNT_AGENTS = document.params.agentsAmount.value;
        neighbourRadius = document.params.neighbourRadius.value;
        observeDegree = document.params.observeDegree.value;
        minDistance = document.params.minDistance.value;
        weightNeighbourVelocity = document.params.weightNeighbourVelocity.value;
        weightNeighbourDistance = document.params.weightNeighbourDistance.value;
        weightMinimalDistance = document.params.weightMinimalDistance.value;
        weightPerturbation = document.params.weightPerturbation.value;
        maxVelocity = document.params.maxVelocity.value;
    };
    function repaint_scene() {
        update_params();
        removeAgentMeshes();
        var createScene = function () {
            const scene = new BABYLON.Scene(engine);
            createCamera(scene, canvas, CAMERA_ANGLE, CAMERA_ZOOM, CAMERA_POS_X, CAMERA_POS_Y);
            createLights(scene);
            createGround(scene, GROUND_WIDTH, GROUND_HEIGHT, INIT_POS_X, INIT_POS_Z);
            init(scene);
            return scene;
        };
        scene = createScene();
    };
</script>
<script src="./js/boids.js"></script>
<script src="./js/sceneSetup.js"></script>
<script src="./js/cameraSetup.js"></script>
<script src="./js/lightSetup.js"></script>
<script src="./js/groundSetup.js"></script>

</html>